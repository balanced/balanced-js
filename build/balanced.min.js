////
// balanced.js
// version: 1.1.21
// built: 2014-12-22
// https://github.com/balanced/balanced-js
////

!function(a,b){function c(a){return parseInt(a,10)}function d(a){return"string"==typeof a}function e(a){return"undefined"!=typeof a}function f(a){return"number"==typeof a}function g(a){return null!==a&&"object"==typeof a}function h(){var a=document.cookie.match(/__b=([a-zA-Z0-9\-!\.]+)/);a=a?a[1]:(new Date).getTime()+"."+Math.random().toString().substr(2)+".0!0",a=a.split("!");var b=a[0].split(".");b.length<3&&(b[1]=Math.random().toString().substr(2),b[2]=0),b[2]++,a=b.join(".")+"!"+a[1];var c=new Date;return c.setDate(c.getDate()+365),document.cookie="__b="+a+" ;expires="+c.toUTCString(),a}function i(a){a.meta||(a.meta={}),u.submitted=(new Date).getTime(),u.scrollX=b.scrollX,u.scrollY=b.scrollY;for(var c in u)"capabilities_"+c in a.meta||(a.meta["capabilities_"+c]=u[c]);return a}function j(a,c,d){a.addEventListener?a.addEventListener(c,d,!1):a.attachEvent&&(a["e"+c+d]=d,a[c+d]=function(){a["e"+c+d](b.event)},a.attachEvent("on"+c,a[c+d]))}function k(a){a=a?a:b.event;var c=!1;return a.shiftKey?c=a.shiftKey:a.modifiers&&(c=!!(4&a.modifiers)),c&&(y=!0),y}function l(a){if(null==a)return!0;for(var b in a)if(t.call(a,b))return!1;return!0}function m(a,b){var c={},d={};if(g(a))for(var e=0;e<a.length;e++)d[a[e]]=b;else d[a]=b;return c.description=b,c.extras=d,c}function n(a,b,c){for(var d=0;d<a.length;d++){var e=a[d];b&&e in b&&b[e]||c.push(m(e,"Invalid field ["+e+'] - Missing field "'+e+'"'))}}function o(a,b,c){var d=[];n(b,a,d);var e=c(a);d=d.concat(e);for(var f=0;f<d.length;f++)d[f].status="Bad Request",d[f].category_code="request",d[f].additional=null,d[f].status_code=400,d[f].category_type="request";return d}function p(a,b){var c=b?b:"No data supplied";if(!a)throw c;a({errors:[{description:c,status:"Bad Request",category_code:"request",additional:null,status_code:400,category_type:"request",extras:{}}],status_code:400})}function q(a,c){var d="balanced_jsonp_"+Math.random().toString().substr(2),f=document.createElement("script");f.type="text/javascript",f.async=!0,f.src=a.replace("{callback}",d);var g=document.getElementsByTagName("script")[0];g.parentNode.insertBefore(f,g),b[d]=function(a){try{c(a)}catch(b){e(console)&&console.error&&console.error(b)}f.parentNode.removeChild(f)}}function r(a,b){return x+a+"?callback={callback}&data="+encodeURIComponent(JSON.stringify(b))}function s(a){function b(b){if(!c){if(c=!0,!b||!b.status)return void a({errors:[{description:"Unable to connect to the balanced servers",status:"Internal Server Error",category_code:"server-error",additional:null,status_code:500,category_type:"server-error",extras:{}}],status_code:500});var d=JSON.parse(b.body);e(b.status)&&(d.status_code=b.status),a(d)}}var c=!1;return setTimeout(b,6e4),b}b.balanced=a,String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")});var t=Object.prototype.hasOwnProperty,u={system_timezone:-(new Date).getTimezoneOffset()/60,user_agent:navigator.userAgent,language:navigator.userLanguage||navigator.language,kp:0,cli:0,loaded:(new Date).getTime(),screen_width:screen.width,screen_length:screen.height,hist:b.history.length,cookie:h()},v=null,w=null,x="https://api.balancedpayments.com",y=!1;j(b,"keydown",function(a){u.cl||(u.cl=k(a)),u.kp++}),j(b,"paste",function(){u.ps=!0}),j(b,"click",function(){u.cli++});var z={isCardNumberValid:function(a){if(!a)return!1;if(a=(a+"").replace(/\D+/g,"").split("").reverse(),!a.length||a.length<12)return!1;var b,d=0;for(b=0;b<a.length;b++)a[b]=c(a[b]),d+=b%2?2*a[b]-(a[b]>4?9:0):a[b];return d%10===0},cardType:function(a){var b={};if(b[51]=b[52]=b[53]=b[54]=b[55]="Mastercard",b[34]=b[37]="American Express",b[4]="VISA",b[6]="Discover Card",b[35]="JCB",b[30]=b[36]=b[38]="Diners Club",a){a=a.toString().trim();for(var c in b)if(0===a.indexOf(c))return b[c]}return null},isCVVValid:function(a,b){var c=z.cardType(a);if(!c)return!1;var e="American Express"===c?4:3;return(d(b)||f(b))&&b.toString().replace(/\D+/g,"").length===e?!0:!1},isSecurityCodeValid:function(a,b){return z.isCVVValid(a,b)},isExpiryValid:function(a,b){if(!a||!b)return!1;if(a=c(a),b=c(b),isNaN(a)||isNaN(b)||a>12||1>a)return!1;var d=new Date;return!(d.getFullYear()>b||d.getFullYear()===b&&d.getMonth()>=a)},validate:function(a){a.number&&(a.number=a.number.toString().trim());var b=a.number,c=a.cvv,d=a.expiration_month,f=a.expiration_year,g=[];return z.isCardNumberValid(b)||g.push(m("number",'Invalid field [number] - "'+b+'" is not a valid credit card number')),e(c)&&null!==c&&!z.isCVVValid(b,c)&&g.push(m("cvv",'Invalid field [cvv] - "'+c+'" is not a valid credit card security code')),z.isExpiryValid(d,f)||g.push(m(["expiration_month","expiration_year"],'Invalid field [expiration_month,expiration_year] - "'+d+"-"+f+'" is not a valid credit card expiration date')),g},create:function(a,b){if(!a)return void p(b);var c=["number","expiration_month","expiration_year"],d=o(a,c,z.validate);l(d)?q(r("/jsonp/cards",i(a)),s(b)):b({errors:d,status_code:400})}},A=/[a-z0-9!#$%&'*+\/=?\^_`{|}~\-]+(?:\.[a-z0-9!#$%&'*+\/=?\^_`{|}~\-]+)*@(?:[a-z0-9](?:[a-z0-9\-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9\-]*[a-z0-9])?/i,B={validate:function(a){return!(!a||!A.test(a))}},C={types:["savings","checking"],validate:function(a){var b="routing_number"in a?"routing_number":"bank_code",c=a[b],d=[];C.isRoutingNumberValid(c)||d.push(m(b,"Invalid field ["+b+'] - "'+c+'" is not a valid '+b.replace("_"," ")));var e=a.type||a.account_type,f="type"in a?"type":"account_type";return a[f]&&!C.validateType(e)&&d.push(m(f,"Invalid field ["+f+'] - "'+e+'" must be one of: "'+C.types.join('", "')+'"')),d},isRoutingNumberValid:function(a){if(!a)return!1;if(a=a.toString().match(/\d+/g),!a)return!1;if(a=a.join(""),!a||9!==a.length)return!1;for(var b=a.toString().split(""),d=[],e=0;e<b.length;e++)d.push(c(b[e]));return d[8]===(7*(d[0]+d[3]+d[6])+3*(d[1]+d[4]+d[7])+9*(d[2]+d[5]))%10},validateRoutingNumber:function(a){return C.isRoutingNumberValid(a)},lookupRoutingNumber:function(a,b){if(!a)return void p(b);var c="/bank_accounts/routing_numbers/"+a;q(r(c,null,s(b)))},validateType:function(a){return a?!!/savings|checking/.exec(a):!0},create:function(a,b){if(!a)return void p(b);var c=["name","account_number","routing_number"],d=o(a,c,C.validate);l(d)?("type"in a&&!("account_type"in a)&&(a.account_type=a.type),q(r("/jsonp/bank_accounts",i(a)),s(b))):b({errors:d,status_code:400})}},D={providers:{coinbase:{url:"https://coinbase.com/oauth/authorize",params:{response_type:"code",client_id:"050f4c85231a51c147a3fb011e012755d81cdb499cc50b5354b7bcdf9bf805ad",redirect_uri:"https://js.balancedpayments.com/callback.html",scope:"send"}}},provider_name:null,callback:null,create:function(a,c){var d=D.providers[a],e=d.url,f=d.params,g=[];if(D.provider_name=a,D.callback=c,f){for(var h in f)g.push(h+"="+f[h]);e=e+"?"+g.join("&")}w=b.open(e,"","top="+(b.outerHeight/2-275)+", left="+(b.outerWidth/2-250)+", width=500, height=550")},configure:function(){}};j(b,"message",function(a){if("https://js.balancedpayments.com"===a.origin){if(!a.data)return void p(D.callback);var b=a.data;b.token=a.data.token||a.data.code,b.provider=D.provider_name,q(r("/jsonp/external_accounts",b),s(D.callback)),w&&w.close()}}),"object"!=typeof JSON&&q("https://js.balancedpayments.com/json2.js"),b.balanced={card:z,bankAccount:C,externalAccount:D,emailAddress:B,init:function(a){a&&(d(a)?v=a:("server"in a&&(x=a.server),"marketplace_href"in a&&(v=a.marketplace_href),"providers"in a&&(D.providers=a.providers)))}}}({},function(){return this}());